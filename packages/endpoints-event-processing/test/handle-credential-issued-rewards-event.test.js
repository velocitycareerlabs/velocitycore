/*
 * Copyright 2025 Velocity Team
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 */

const mockReadDocument = jest.fn().mockResolvedValue(undefined);
const mockWriteDocument = jest.fn().mockResolvedValue(undefined);
const mockInitReadDocument = jest.fn().mockReturnValue(mockReadDocument);
const mockInitWriteDocument = jest.fn().mockReturnValue(mockWriteDocument);
const mockBatchTransferCredits = jest.fn().mockResolvedValue([]);
const mockEventCursor = jest.fn();
const mockEventCursorNext = jest.fn();

const mockPullAddedCredentialMetadataEvents = jest
  .fn()
  .mockResolvedValue({ eventsCursor: mockEventCursor, latestBlock: 42 });
const mockInitMetadataRegistry = jest.fn().mockImplementation(async () => {
  return {
    pullAddedCredentialMetadataEvents: mockPullAddedCredentialMetadataEvents,
  };
});

const { get2BytesHash } = require('@velocitycareerlabs/crypto');
const { map } = require('lodash/fp');
const {
  bindRepo,
  mongoDb,
  mongoFactory,
} = require('@spencejs/spence-mongo-repos');
const { ObjectId } = require('mongodb');
const { mongoCloseWrapper } = require('@velocitycareerlabs/tests-helpers');
const initOrganizationFactory = require('@velocitycareerlabs/endpoints-organizations-registrar/test/factories/organizations-factory');
const organizationsRepoPlugin = require('@velocitycareerlabs/endpoints-organizations-registrar/src/entities/organizations/repos/repo');
const initCredentialSchemaFactory = require('../../endpoints-credential-types-registrar/test/factories/credential-schema-factory');
const credentialSchemasRepoPlugin = require('../../endpoints-credential-types-registrar/src/entities/credential-types/repos/repo');

const { TransactionTypes } = require('../src/entities');
const {
  events: sampleCredentialEventsArray,
} = require('./data/sample-credential-events-array');
const { handleCredentialIssuedRewardsEvent } = require('../src/handlers');

jest.mock('@velocitycareerlabs/aws-clients', () => {
  const originalModule = jest.requireActual('@velocitycareerlabs/aws-clients');

  return {
    ...originalModule,
    initReadDocument: mockInitReadDocument,
    initWriteDocument: mockInitWriteDocument,
  };
});

jest.mock('@velocitycareerlabs/fineract-client', () => {
  const originalModule = jest.requireActual(
    '@velocitycareerlabs/fineract-client'
  );
  return {
    ...originalModule,
    batchTransferCredits: mockBatchTransferCredits,
  };
});

jest.mock('@velocitycareerlabs/metadata-registration', () => {
  const originalModule = jest.requireActual(
    '@velocitycareerlabs/metadata-registration'
  );
  return {
    ...originalModule,
    initMetadataRegistry: mockInitMetadataRegistry,
  };
});

describe('Credential issued event rewards distribution task test suite', () => {
  const task = 'credential-issued-rewards';
  const config = {
    mongoConnection: 'mongodb://localhost:27017/oracle',
    nodeEnv: 'test',
    rootDid: 'did:velocity:rootissuer1234567890',
    rootPrivateKey:
      '071d76d6395c725960f2f6343bd26cc56173679b3ae33292d99d7abc289832bf',
    rootKid: 'did:velocity:rootissuer1234567890#key-1',
    issuerRewardAmount: 5,
    caoRewardAmount: 7,
    vnfRewardDispersalAccountId: 'abc123',
  };
  const testContext = { config, log: console };
  let persistOrganization;
  let newOrganization;
  let organizations;
  let credentialSchemas;
  let credentialSchemaHashLayer1;
  let credentialSchemaHashLayer2;
  let persistCredentialSchema;

  beforeAll(async () => {
    await mongoFactory(testContext);
    organizationsRepoPlugin(testContext);
    credentialSchemasRepoPlugin(testContext);
    testContext.repos = bindRepo(testContext);
    ({ persistOrganization, newOrganization } =
      initOrganizationFactory(testContext));
    ({ persistCredentialSchema } = initCredentialSchemaFactory(testContext));
  });

  beforeEach(async () => {
    jest.clearAllMocks();
    await mongoDb().collection('organizations').deleteMany({});
    await mongoDb().collection('credentialSchemas').deleteMany({});

    const org = await newOrganization();
    credentialSchemas = await Promise.all([
      persistCredentialSchema({
        credentialType: 'test-credential-type-0',
      }),
      persistCredentialSchema({
        credentialType: 'test-credential-type-1',
        layer1: false,
      }),
    ]);
    credentialSchemaHashLayer1 = get2BytesHash(
      credentialSchemas[0].credentialType
    );
    credentialSchemaHashLayer2 = get2BytesHash(
      credentialSchemas[1].credentialType
    );
    organizations = await Promise.all([
      persistOrganization(),
      persistOrganization({
        ...org,
        didDoc: {
          ...org.didDoc,
          id: 'did:velocity:0xd4df29726d500f9b85bc6c7f1b3c021f16305692',
        },
      }),
      persistOrganization({
        ...org,
        didDoc: {
          ...org.didDoc,
          id: 'did:velocity:42',
          alsoKnownAs: ['did:aka:foo'],
        },
        ids: {
          ...org.ids,
          tokenAccountId: '11',
        },
      }),
    ]);
    mockEventCursor.mockImplementation(() => {
      return {
        [Symbol.asyncIterator]: () => {
          return {
            next: mockEventCursorNext
              .mockImplementationOnce(async () => {
                return { value: [] };
              })
              .mockImplementationOnce(async () => {
                return {
                  value: map(
                    (ev) => ({
                      ...ev,
                      args: [
                        ev.args[0],
                        ev.args[1],
                        ev.args[2],
                        credentialSchemaHashLayer1,
                        ev.args[4],
                        ev.args[5],
                        ev.args[6],
                      ],
                    }),
                    sampleCredentialEventsArray
                  ),
                };
              })
              .mockImplementationOnce(async () => {
                return { done: true };
              }),
          };
        },
      };
    });
  });

  afterAll(async () => {
    await mongoCloseWrapper();
  });

  it('Should successfully distribute rewards for a given set of events read off the blockchain', async () => {
    mockReadDocument.mockResolvedValue({
      Item: {
        EventName: task,
        BlockNumber: 1,
      },
    });

    const eventsForMock = [
      {
        blockNumber: 157143,
        blockHash:
          '0x6eeb22a01c33cecb0a117252fed4fee1948d9cd19a7d30fc7c8fc338ec82bd4e',
        transactionIndex: 0,
        removed: false,
        address: '0x9c7A0CD7829c31259b2D19B808a69687267c939b',
        // eslint-disable-next-line max-len
        data: '0x0000000000000000000000006f80d1630992e6634e4f7cd5af1beb9830e47edd00000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000000000000000000000000000000000000000001673200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000044000000000000000000000000000000000000000000000000000000000000002ea65794a30655841694f694a4b563151694c434a72615751694f694a6b61575136646d567362324e7064486b364d48686b4e47526d4d6a6b334d6a5a6b4e5441775a6a6c694f445669597a5a6a4e325978596a4e6a4d4449785a6a45324d7a41314e6a6b794932746c65533078496977695957786e496a6f6952564d794e545a4c496e302e65794a325979493665794a306558426c496a7062496b4e795a57526c626e52705957784e5a5852685a47463059557870633352495a57466b5a5849695853776959334a6c5a47567564476c6862464e31596d706c593351694f6e736962476c7a64456c6b496a6f784d6a4d73496d466a59323931626e524a5a434936496a42344d54566a515455784e6a4931513055354e6a51315a4463774d54557a4e5449774e6d45325254597a596a42454d5464684d5441354f534a396653776961584e7a496a6f695a476c6b4f6e5a6c6247396a615852354f6a42345a44526b5a6a49354e7a49325a4455774d475935596a6731596d4d32597a646d4d57497a597a41794d5759784e6a4d774e5459354d694973496d703061534936496d5630614756795a5856744f6a42344d4449794e444d304d6a49774e6d4d77597a51354f54466c4f44646959554a6b516a6c47596a5a6c513255304d44526a4e3252465153396e5a5854516f584a6c5a47567564476c686245316c6447466b5958526854476c7a64456c7a6333566c636c5a445032466b5a484a6c63334d394d4867784e574e424e5445324d6a564452546b324e44566b4e7a41784e544d314d6a413259545a464e6a4e694d4551784e3245784d446b354a6d78706333524a5a4430784d6a4d694c434a70595851694f6a45324e4441794e6a6b344e545173496d35695a6949364d5459304d4449324f5467314e48302e4179555a753977626942756a4f506853756b5278495843504c65334b36475a68734b2d6431337036704d667855685048366b5a41475a6d534562635166484d33456845726237507378664971475f75546572366f2d6700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a747261636b696e67496400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f6469643a76656c6f636974793a34320000000000000000000000000000000000',
        topics: [
          '0x5b3dbf2c1245cb7fe5833a37872aae67caba79bd65f30522e778fc48297376a5',
        ],
        transactionHash:
          '0x2b50833123fe62a229aaa7143d4f62f12d6d6f2c10ef34ef9c246212f24d0ce5',
        logIndex: 0,
        event: 'AddedCredentialMetadata',
        eventSignature:
          'AddedCredentialMetadata(address,bytes,uint256,bytes2,uint32,string,string)',
        args: [
          '0x6F80d1630992e6634e4f7Cd5af1BeB9830e47EdD',
          // eslint-disable-next-line max-len
          '0x65794a30655841694f694a4b563151694c434a72615751694f694a6b61575136646d567362324e7064486b364d48686b4e47526d4d6a6b334d6a5a6b4e5441775a6a6c694f445669597a5a6a4e325978596a4e6a4d4449785a6a45324d7a41314e6a6b794932746c65533078496977695957786e496a6f6952564d794e545a4c496e302e65794a325979493665794a306558426c496a7062496b4e795a57526c626e52705957784e5a5852685a47463059557870633352495a57466b5a5849695853776959334a6c5a47567564476c6862464e31596d706c593351694f6e736962476c7a64456c6b496a6f784d6a4d73496d466a59323931626e524a5a434936496a42344d54566a515455784e6a4931513055354e6a51315a4463774d54557a4e5449774e6d45325254597a596a42454d5464684d5441354f534a396653776961584e7a496a6f695a476c6b4f6e5a6c6247396a615852354f6a42345a44526b5a6a49354e7a49325a4455774d475935596a6731596d4d32597a646d4d57497a597a41794d5759784e6a4d774e5459354d694973496d703061534936496d5630614756795a5856744f6a42344d4449794e444d304d6a49774e6d4d77597a51354f54466c4f44646959554a6b516a6c47596a5a6c513255304d44526a4e3252465153396e5a5854516f584a6c5a47567564476c686245316c6447466b5958526854476c7a64456c7a6333566c636c5a445032466b5a484a6c63334d394d4867784e574e424e5445324d6a564452546b324e44566b4e7a41784e544d314d6a413259545a464e6a4e694d4551784e3245784d446b354a6d78706333524a5a4430784d6a4d694c434a70595851694f6a45324e4441794e6a6b344e545173496d35695a6949364d5459304d4449324f5467314e48302e4179555a753977626942756a4f506853756b5278495843504c65334b36475a68734b2d6431337036704d667855685048366b5a41475a6d534562635166484d33456845726237507378664971475f75546572366f2d67',
          {
            type: 'BigNumber',
            hex: '0x01',
          },
          credentialSchemaHashLayer1,
          1,
          'trackingId',
          'did:velocity:0xd4df29726d500f9b85bc6c7f1b3c021f16305692',
        ],
      },
      {
        blockNumber: 157144,
        blockHash:
          '0x635702479e12c015e5d99b006cbcd8e3b83bb54bd7d390b2e3804a8fd7e48280',
        transactionIndex: 0,
        removed: false,
        address: '0x9c7A0CD7829c31259b2D19B808a69687267c939b',
        // eslint-disable-next-line max-len
        data: '0x0000000000000000000000006f80d1630992e6634e4f7cd5af1beb9830e47edd00000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000000000000000000000000000000000000000001673200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000044000000000000000000000000000000000000000000000000000000000000002ea65794a30655841694f694a4b563151694c434a72615751694f694a6b61575136646d567362324e7064486b364d48686b4e47526d4d6a6b334d6a5a6b4e5441775a6a6c694f445669597a5a6a4e325978596a4e6a4d4449785a6a45324d7a41314e6a6b794932746c65533078496977695957786e496a6f6952564d794e545a4c496e302e65794a325979493665794a306558426c496a7062496b4e795a57526c626e52705957784e5a5852685a47463059557870633352495a57466b5a5849695853776959334a6c5a47567564476c6862464e31596d706c593351694f6e736962476c7a64456c6b496a6f784d6a4d73496d466a59323931626e524a5a434936496a42344d54566a515455784e6a4931513055354e6a51315a4463774d54557a4e5449774e6d45325254597a596a42454d5464684d5441354f534a396653776961584e7a496a6f695a476c6b4f6e5a6c6247396a615852354f6a42345a44526b5a6a49354e7a49325a4455774d475935596a6731596d4d32597a646d4d57497a597a41794d5759784e6a4d774e5459354d694973496d703061534936496d5630614756795a5856744f6a42344d4449794e444d304d6a49774e6d4d77597a51354f54466c4f44646959554a6b516a6c47596a5a6c513255304d44526a4e3252465153396e5a5854516f584a6c5a47567564476c686245316c6447466b5958526854476c7a64456c7a6333566c636c5a445032466b5a484a6c63334d394d4867784e574e424e5445324d6a564452546b324e44566b4e7a41784e544d314d6a413259545a464e6a4e694d4551784e3245784d446b354a6d78706333524a5a4430784d6a4d694c434a70595851694f6a45324e4441794e6a6b344e545173496d35695a6949364d5459304d4449324f5467314e48302e4179555a753977626942756a4f506853756b5278495843504c65334b36475a68734b2d6431337036704d667855685048366b5a41475a6d534562635166484d33456845726237507378664971475f75546572366f2d6700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a747261636b696e67496400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f6469643a76656c6f636974793a34320000000000000000000000000000000000',
        topics: [
          '0x5b3dbf2c1245cb7fe5833a37872aae67caba79bd65f30522e778fc48297376a5',
        ],
        transactionHash:
          '0xff7494996821a28cffc9e5d95b4851961322e5f32269e87c4d6fad7f5626e699',
        logIndex: 0,
        event: 'AddedCredentialMetadata',
        eventSignature:
          'AddedCredentialMetadata(address,bytes,uint256,bytes2,uint32,string,string)',
        args: [
          '0x6F80d1630992e6634e4f7Cd5af1BeB9830e47EdD',
          // eslint-disable-next-line max-len
          '0x65794a30655841694f694a4b563151694c434a72615751694f694a6b61575136646d567362324e7064486b364d48686b4e47526d4d6a6b334d6a5a6b4e5441775a6a6c694f445669597a5a6a4e325978596a4e6a4d4449785a6a45324d7a41314e6a6b794932746c65533078496977695957786e496a6f6952564d794e545a4c496e302e65794a325979493665794a306558426c496a7062496b4e795a57526c626e52705957784e5a5852685a47463059557870633352495a57466b5a5849695853776959334a6c5a47567564476c6862464e31596d706c593351694f6e736962476c7a64456c6b496a6f784d6a4d73496d466a59323931626e524a5a434936496a42344d54566a515455784e6a4931513055354e6a51315a4463774d54557a4e5449774e6d45325254597a596a42454d5464684d5441354f534a396653776961584e7a496a6f695a476c6b4f6e5a6c6247396a615852354f6a42345a44526b5a6a49354e7a49325a4455774d475935596a6731596d4d32597a646d4d57497a597a41794d5759784e6a4d774e5459354d694973496d703061534936496d5630614756795a5856744f6a42344d4449794e444d304d6a49774e6d4d77597a51354f54466c4f44646959554a6b516a6c47596a5a6c513255304d44526a4e3252465153396e5a5854516f584a6c5a47567564476c686245316c6447466b5958526854476c7a64456c7a6333566c636c5a445032466b5a484a6c63334d394d4867784e574e424e5445324d6a564452546b324e44566b4e7a41784e544d314d6a413259545a464e6a4e694d4551784e3245784d446b354a6d78706333524a5a4430784d6a4d694c434a70595851694f6a45324e4441794e6a6b344e545173496d35695a6949364d5459304d4449324f5467314e48302e4179555a753977626942756a4f506853756b5278495843504c65334b36475a68734b2d6431337036704d667855685048366b5a41475a6d534562635166484d33456845726237507378664971475f75546572366f2d67',
          {
            type: 'BigNumber',
            hex: '0x01',
          },
          credentialSchemaHashLayer1,
          2,
          'trackingId',
          'did:velocity:0xd4df29726d500f9b85bc6c7f1b3c021f16305692',
        ],
      },
      {
        blockNumber: 157145,
        blockHash:
          '0x635702479e12c015e5d99b006cbcd8e3b83bb54bd7d390b2e3804a8fd7e48280',
        transactionIndex: 0,
        removed: false,
        address: '0x9c7A0CD7829c31259b2D19B808a69687267c939b',
        // eslint-disable-next-line max-len
        data: '0x0000000000000000000000006f80d1630992e6634e4f7cd5af1beb9830e47edd00000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000000000000000000000000000000000000000001673200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000044000000000000000000000000000000000000000000000000000000000000002ea65794a30655841694f694a4b563151694c434a72615751694f694a6b61575136646d567362324e7064486b364d48686b4e47526d4d6a6b334d6a5a6b4e5441775a6a6c694f445669597a5a6a4e325978596a4e6a4d4449785a6a45324d7a41314e6a6b794932746c65533078496977695957786e496a6f6952564d794e545a4c496e302e65794a325979493665794a306558426c496a7062496b4e795a57526c626e52705957784e5a5852685a47463059557870633352495a57466b5a5849695853776959334a6c5a47567564476c6862464e31596d706c593351694f6e736962476c7a64456c6b496a6f784d6a4d73496d466a59323931626e524a5a434936496a42344d54566a515455784e6a4931513055354e6a51315a4463774d54557a4e5449774e6d45325254597a596a42454d5464684d5441354f534a396653776961584e7a496a6f695a476c6b4f6e5a6c6247396a615852354f6a42345a44526b5a6a49354e7a49325a4455774d475935596a6731596d4d32597a646d4d57497a597a41794d5759784e6a4d774e5459354d694973496d703061534936496d5630614756795a5856744f6a42344d4449794e444d304d6a49774e6d4d77597a51354f54466c4f44646959554a6b516a6c47596a5a6c513255304d44526a4e3252465153396e5a5854516f584a6c5a47567564476c686245316c6447466b5958526854476c7a64456c7a6333566c636c5a445032466b5a484a6c63334d394d4867784e574e424e5445324d6a564452546b324e44566b4e7a41784e544d314d6a413259545a464e6a4e694d4551784e3245784d446b354a6d78706333524a5a4430784d6a4d694c434a70595851694f6a45324e4441794e6a6b344e545173496d35695a6949364d5459304d4449324f5467314e48302e4179555a753977626942756a4f506853756b5278495843504c65334b36475a68734b2d6431337036704d667855685048366b5a41475a6d534562635166484d33456845726237507378664971475f75546572366f2d6700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a747261636b696e67496400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f6469643a76656c6f636974793a34320000000000000000000000000000000000',
        topics: [
          '0x5b3dbf2c1245cb7fe5833a37872aae67caba79bd65f30522e778fc48297376a5',
        ],
        transactionHash:
          '0xff7494996821a28cffc9e5d95b4851961322e5f32269e87c4d6fad7f5626e699',
        logIndex: 0,
        event: 'AddedCredentialMetadata',
        eventSignature:
          'AddedCredentialMetadata(address,bytes,uint256,bytes2,uint32,string,string)',
        args: [
          '0x6F80d1630992e6634e4f7Cd5af1BeB9830e47EdD',
          // eslint-disable-next-line max-len
          '0x65794a30655841694f694a4b563151694c434a72615751694f694a6b61575136646d567362324e7064486b364d48686b4e47526d4d6a6b334d6a5a6b4e5441775a6a6c694f445669597a5a6a4e325978596a4e6a4d4449785a6a45324d7a41314e6a6b794932746c65533078496977695957786e496a6f6952564d794e545a4c496e302e65794a325979493665794a306558426c496a7062496b4e795a57526c626e52705957784e5a5852685a47463059557870633352495a57466b5a5849695853776959334a6c5a47567564476c6862464e31596d706c593351694f6e736962476c7a64456c6b496a6f784d6a4d73496d466a59323931626e524a5a434936496a42344d54566a515455784e6a4931513055354e6a51315a4463774d54557a4e5449774e6d45325254597a596a42454d5464684d5441354f534a396653776961584e7a496a6f695a476c6b4f6e5a6c6247396a615852354f6a42345a44526b5a6a49354e7a49325a4455774d475935596a6731596d4d32597a646d4d57497a597a41794d5759784e6a4d774e5459354d694973496d703061534936496d5630614756795a5856744f6a42344d4449794e444d304d6a49774e6d4d77597a51354f54466c4f44646959554a6b516a6c47596a5a6c513255304d44526a4e3252465153396e5a5854516f584a6c5a47567564476c686245316c6447466b5958526854476c7a64456c7a6333566c636c5a445032466b5a484a6c63334d394d4867784e574e424e5445324d6a564452546b324e44566b4e7a41784e544d314d6a413259545a464e6a4e694d4551784e3245784d446b354a6d78706333524a5a4430784d6a4d694c434a70595851694f6a45324e4441794e6a6b344e545173496d35695a6949364d5459304d4449324f5467314e48302e4179555a753977626942756a4f506853756b5278495843504c65334b36475a68734b2d6431337036704d667855685048366b5a41475a6d534562635166484d33456845726237507378664971475f75546572366f2d67',
          {
            type: 'BigNumber',
            hex: '0x01',
          },
          credentialSchemaHashLayer1,
          2,
          'trackingId',
          'did:velocity:42',
        ],
      },
    ];
    mockEventCursorNext.mockReset();
    mockEventCursor.mockImplementation(() => {
      return {
        [Symbol.asyncIterator]: () => {
          return {
            next: mockEventCursorNext
              .mockImplementationOnce(async () => {
                return { value: [] };
              })
              .mockImplementationOnce(async () => {
                return { value: eventsForMock };
              })
              .mockImplementationOnce(async () => {
                return { done: true };
              }),
          };
        },
      };
    });

    const func = async () => handleCredentialIssuedRewardsEvent(testContext);

    await expect(func()).resolves.toEqual(undefined);
    expect(mockInitReadDocument).toHaveBeenCalledTimes(1);
    expect(mockInitWriteDocument).toHaveBeenCalledTimes(1);
    expect(mockInitMetadataRegistry).toHaveBeenCalledTimes(1);

    expect(mockReadDocument).toHaveBeenCalledTimes(1);
    expect(mockReadDocument).toHaveBeenCalledWith(
      testContext.config.dynamoDbTableEventBlock,
      { EventName: task }
    );

    expect(mockPullAddedCredentialMetadataEvents).toHaveBeenCalledTimes(1);
    expect(mockPullAddedCredentialMetadataEvents).toHaveBeenCalledWith(2);

    expect(mockBatchTransferCredits).toHaveBeenCalledTimes(1);
    expect(mockBatchTransferCredits).toHaveBeenCalledWith(
      {
        transfers: expect.arrayContaining([
          {
            amount: 7,
            fromAccount: 'abc123',
            description: TransactionTypes.CAO_ISSUING_REWARD,
            toAccount: '11',
          },
          {
            amount: 14,
            fromAccount: 'abc123',
            toAccount: '9',
            description: TransactionTypes.CAO_ISSUING_REWARD,
          },
          {
            amount: 15,
            fromAccount: 'abc123',
            toAccount: '9',
            description: TransactionTypes.ISSUER_ISSUING_REWARD,
          },
        ]),
      },
      testContext
    );
    expect(mockWriteDocument).toHaveBeenCalledTimes(1);
    expect(mockWriteDocument).toHaveBeenCalledWith(
      testContext.config.dynamoDbTableEventBlock,
      {
        EventName: task,
        BlockNumber: 42,
      }
    );
    expect(mockEventCursor).toHaveBeenCalledTimes(1);
    expect(mockEventCursorNext).toHaveBeenCalledTimes(3);
  });

  it('Should successfully distribute rewards for a given set of events and create two transaction for one organization', async () => {
    mockReadDocument.mockResolvedValue({
      Item: {
        EventName: task,
        BlockNumber: 1,
      },
    });

    const func = async () => handleCredentialIssuedRewardsEvent(testContext);

    await expect(func()).resolves.toEqual(undefined);
    expect(mockInitReadDocument).toHaveBeenCalledTimes(1);
    expect(mockInitWriteDocument).toHaveBeenCalledTimes(1);
    expect(mockInitMetadataRegistry).toHaveBeenCalledTimes(1);

    expect(mockReadDocument).toHaveBeenCalledTimes(1);
    expect(mockReadDocument).toHaveBeenCalledWith(
      testContext.config.dynamoDbTableEventBlock,
      { EventName: task }
    );

    expect(mockPullAddedCredentialMetadataEvents).toHaveBeenCalledTimes(1);
    expect(mockPullAddedCredentialMetadataEvents).toHaveBeenCalledWith(2);

    expect(mockBatchTransferCredits).toHaveBeenCalledTimes(1);
    expect(mockBatchTransferCredits).toHaveBeenCalledWith(
      {
        transfers: expect.arrayContaining([
          {
            amount: 49,
            fromAccount: 'abc123',
            toAccount: '11',
            description: TransactionTypes.CAO_ISSUING_REWARD,
          },
          {
            amount: 7,
            fromAccount: 'abc123',
            toAccount: '11',
            description: TransactionTypes.CAO_ISSUING_REWARD,
          },
          {
            amount: 40,
            fromAccount: 'abc123',
            toAccount: '9',
            description: TransactionTypes.ISSUER_ISSUING_REWARD,
          },
        ]),
      },
      testContext
    );
    expect(mockWriteDocument).toHaveBeenCalledTimes(1);
    expect(mockWriteDocument).toHaveBeenCalledWith(
      testContext.config.dynamoDbTableEventBlock,
      {
        EventName: task,
        BlockNumber: 42,
      }
    );
  });

  it('Should distribute rewards only for layer 1 credentials', async () => {
    mockReadDocument.mockResolvedValue({
      Item: {
        EventName: task,
        BlockNumber: 1,
      },
    });
    const eventsForMock = [
      {
        blockNumber: 157143,
        blockHash:
          '0x6eeb22a01c33cecb0a117252fed4fee1948d9cd19a7d30fc7c8fc338ec82bd4e',
        transactionIndex: 0,
        removed: false,
        address: '0x9c7A0CD7829c31259b2D19B808a69687267c939b',
        // eslint-disable-next-line max-len
        data: '0x0000000000000000000000006f80d1630992e6634e4f7cd5af1beb9830e47edd00000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000000000000000000000000000000000000000001673200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000044000000000000000000000000000000000000000000000000000000000000002ea65794a30655841694f694a4b563151694c434a72615751694f694a6b61575136646d567362324e7064486b364d48686b4e47526d4d6a6b334d6a5a6b4e5441775a6a6c694f445669597a5a6a4e325978596a4e6a4d4449785a6a45324d7a41314e6a6b794932746c65533078496977695957786e496a6f6952564d794e545a4c496e302e65794a325979493665794a306558426c496a7062496b4e795a57526c626e52705957784e5a5852685a47463059557870633352495a57466b5a5849695853776959334a6c5a47567564476c6862464e31596d706c593351694f6e736962476c7a64456c6b496a6f784d6a4d73496d466a59323931626e524a5a434936496a42344d54566a515455784e6a4931513055354e6a51315a4463774d54557a4e5449774e6d45325254597a596a42454d5464684d5441354f534a396653776961584e7a496a6f695a476c6b4f6e5a6c6247396a615852354f6a42345a44526b5a6a49354e7a49325a4455774d475935596a6731596d4d32597a646d4d57497a597a41794d5759784e6a4d774e5459354d694973496d703061534936496d5630614756795a5856744f6a42344d4449794e444d304d6a49774e6d4d77597a51354f54466c4f44646959554a6b516a6c47596a5a6c513255304d44526a4e3252465153396e5a5854516f584a6c5a47567564476c686245316c6447466b5958526854476c7a64456c7a6333566c636c5a445032466b5a484a6c63334d394d4867784e574e424e5445324d6a564452546b324e44566b4e7a41784e544d314d6a413259545a464e6a4e694d4551784e3245784d446b354a6d78706333524a5a4430784d6a4d694c434a70595851694f6a45324e4441794e6a6b344e545173496d35695a6949364d5459304d4449324f5467314e48302e4179555a753977626942756a4f506853756b5278495843504c65334b36475a68734b2d6431337036704d667855685048366b5a41475a6d534562635166484d33456845726237507378664971475f75546572366f2d6700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a747261636b696e67496400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f6469643a76656c6f636974793a34320000000000000000000000000000000000',
        topics: [
          '0x5b3dbf2c1245cb7fe5833a37872aae67caba79bd65f30522e778fc48297376a5',
        ],
        transactionHash:
          '0x2b50833123fe62a229aaa7143d4f62f12d6d6f2c10ef34ef9c246212f24d0ce5',
        logIndex: 0,
        event: 'AddedCredentialMetadata',
        eventSignature:
          'AddedCredentialMetadata(address,bytes,uint256,bytes2,uint32,string,string)',
        args: [
          '0x6F80d1630992e6634e4f7Cd5af1BeB9830e47EdD',
          // eslint-disable-next-line max-len
          '0x65794a30655841694f694a4b563151694c434a72615751694f694a6b61575136646d567362324e7064486b364d48686b4e47526d4d6a6b334d6a5a6b4e5441775a6a6c694f445669597a5a6a4e325978596a4e6a4d4449785a6a45324d7a41314e6a6b794932746c65533078496977695957786e496a6f6952564d794e545a4c496e302e65794a325979493665794a306558426c496a7062496b4e795a57526c626e52705957784e5a5852685a47463059557870633352495a57466b5a5849695853776959334a6c5a47567564476c6862464e31596d706c593351694f6e736962476c7a64456c6b496a6f784d6a4d73496d466a59323931626e524a5a434936496a42344d54566a515455784e6a4931513055354e6a51315a4463774d54557a4e5449774e6d45325254597a596a42454d5464684d5441354f534a396653776961584e7a496a6f695a476c6b4f6e5a6c6247396a615852354f6a42345a44526b5a6a49354e7a49325a4455774d475935596a6731596d4d32597a646d4d57497a597a41794d5759784e6a4d774e5459354d694973496d703061534936496d5630614756795a5856744f6a42344d4449794e444d304d6a49774e6d4d77597a51354f54466c4f44646959554a6b516a6c47596a5a6c513255304d44526a4e3252465153396e5a5854516f584a6c5a47567564476c686245316c6447466b5958526854476c7a64456c7a6333566c636c5a445032466b5a484a6c63334d394d4867784e574e424e5445324d6a564452546b324e44566b4e7a41784e544d314d6a413259545a464e6a4e694d4551784e3245784d446b354a6d78706333524a5a4430784d6a4d694c434a70595851694f6a45324e4441794e6a6b344e545173496d35695a6949364d5459304d4449324f5467314e48302e4179555a753977626942756a4f506853756b5278495843504c65334b36475a68734b2d6431337036704d667855685048366b5a41475a6d534562635166484d33456845726237507378664971475f75546572366f2d67',
          {
            type: 'BigNumber',
            hex: '0x01',
          },
          credentialSchemaHashLayer2,
          1,
          'trackingId',
          'did:velocity:0xd4df29726d500f9b85bc6c7f1b3c021f16305692',
        ],
      },
      {
        blockNumber: 157144,
        blockHash:
          '0x635702479e12c015e5d99b006cbcd8e3b83bb54bd7d390b2e3804a8fd7e48280',
        transactionIndex: 0,
        removed: false,
        address: '0x9c7A0CD7829c31259b2D19B808a69687267c939b',
        // eslint-disable-next-line max-len
        data: '0x0000000000000000000000006f80d1630992e6634e4f7cd5af1beb9830e47edd00000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000000000000000000000000000000000000000001673200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000044000000000000000000000000000000000000000000000000000000000000002ea65794a30655841694f694a4b563151694c434a72615751694f694a6b61575136646d567362324e7064486b364d48686b4e47526d4d6a6b334d6a5a6b4e5441775a6a6c694f445669597a5a6a4e325978596a4e6a4d4449785a6a45324d7a41314e6a6b794932746c65533078496977695957786e496a6f6952564d794e545a4c496e302e65794a325979493665794a306558426c496a7062496b4e795a57526c626e52705957784e5a5852685a47463059557870633352495a57466b5a5849695853776959334a6c5a47567564476c6862464e31596d706c593351694f6e736962476c7a64456c6b496a6f784d6a4d73496d466a59323931626e524a5a434936496a42344d54566a515455784e6a4931513055354e6a51315a4463774d54557a4e5449774e6d45325254597a596a42454d5464684d5441354f534a396653776961584e7a496a6f695a476c6b4f6e5a6c6247396a615852354f6a42345a44526b5a6a49354e7a49325a4455774d475935596a6731596d4d32597a646d4d57497a597a41794d5759784e6a4d774e5459354d694973496d703061534936496d5630614756795a5856744f6a42344d4449794e444d304d6a49774e6d4d77597a51354f54466c4f44646959554a6b516a6c47596a5a6c513255304d44526a4e3252465153396e5a5854516f584a6c5a47567564476c686245316c6447466b5958526854476c7a64456c7a6333566c636c5a445032466b5a484a6c63334d394d4867784e574e424e5445324d6a564452546b324e44566b4e7a41784e544d314d6a413259545a464e6a4e694d4551784e3245784d446b354a6d78706333524a5a4430784d6a4d694c434a70595851694f6a45324e4441794e6a6b344e545173496d35695a6949364d5459304d4449324f5467314e48302e4179555a753977626942756a4f506853756b5278495843504c65334b36475a68734b2d6431337036704d667855685048366b5a41475a6d534562635166484d33456845726237507378664971475f75546572366f2d6700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a747261636b696e67496400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f6469643a76656c6f636974793a34320000000000000000000000000000000000',
        topics: [
          '0x5b3dbf2c1245cb7fe5833a37872aae67caba79bd65f30522e778fc48297376a5',
        ],
        transactionHash:
          '0xff7494996821a28cffc9e5d95b4851961322e5f32269e87c4d6fad7f5626e699',
        logIndex: 0,
        event: 'AddedCredentialMetadata',
        eventSignature:
          'AddedCredentialMetadata(address,bytes,uint256,bytes2,uint32,string,string)',
        args: [
          '0x6F80d1630992e6634e4f7Cd5af1BeB9830e47EdD',
          // eslint-disable-next-line max-len
          '0x65794a30655841694f694a4b563151694c434a72615751694f694a6b61575136646d567362324e7064486b364d48686b4e47526d4d6a6b334d6a5a6b4e5441775a6a6c694f445669597a5a6a4e325978596a4e6a4d4449785a6a45324d7a41314e6a6b794932746c65533078496977695957786e496a6f6952564d794e545a4c496e302e65794a325979493665794a306558426c496a7062496b4e795a57526c626e52705957784e5a5852685a47463059557870633352495a57466b5a5849695853776959334a6c5a47567564476c6862464e31596d706c593351694f6e736962476c7a64456c6b496a6f784d6a4d73496d466a59323931626e524a5a434936496a42344d54566a515455784e6a4931513055354e6a51315a4463774d54557a4e5449774e6d45325254597a596a42454d5464684d5441354f534a396653776961584e7a496a6f695a476c6b4f6e5a6c6247396a615852354f6a42345a44526b5a6a49354e7a49325a4455774d475935596a6731596d4d32597a646d4d57497a597a41794d5759784e6a4d774e5459354d694973496d703061534936496d5630614756795a5856744f6a42344d4449794e444d304d6a49774e6d4d77597a51354f54466c4f44646959554a6b516a6c47596a5a6c513255304d44526a4e3252465153396e5a5854516f584a6c5a47567564476c686245316c6447466b5958526854476c7a64456c7a6333566c636c5a445032466b5a484a6c63334d394d4867784e574e424e5445324d6a564452546b324e44566b4e7a41784e544d314d6a413259545a464e6a4e694d4551784e3245784d446b354a6d78706333524a5a4430784d6a4d694c434a70595851694f6a45324e4441794e6a6b344e545173496d35695a6949364d5459304d4449324f5467314e48302e4179555a753977626942756a4f506853756b5278495843504c65334b36475a68734b2d6431337036704d667855685048366b5a41475a6d534562635166484d33456845726237507378664971475f75546572366f2d67',
          {
            type: 'BigNumber',
            hex: '0x01',
          },
          credentialSchemaHashLayer1,
          2,
          'trackingId',
          'did:velocity:0xd4df29726d500f9b85bc6c7f1b3c021f16305692',
        ],
      },
      {
        blockNumber: 157145,
        blockHash:
          '0x635702479e12c015e5d99b006cbcd8e3b83bb54bd7d390b2e3804a8fd7e48280',
        transactionIndex: 0,
        removed: false,
        address: '0x9c7A0CD7829c31259b2D19B808a69687267c939b',
        // eslint-disable-next-line max-len
        data: '0x0000000000000000000000006f80d1630992e6634e4f7cd5af1beb9830e47edd00000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000000000000000000000000000000000000000001673200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000044000000000000000000000000000000000000000000000000000000000000002ea65794a30655841694f694a4b563151694c434a72615751694f694a6b61575136646d567362324e7064486b364d48686b4e47526d4d6a6b334d6a5a6b4e5441775a6a6c694f445669597a5a6a4e325978596a4e6a4d4449785a6a45324d7a41314e6a6b794932746c65533078496977695957786e496a6f6952564d794e545a4c496e302e65794a325979493665794a306558426c496a7062496b4e795a57526c626e52705957784e5a5852685a47463059557870633352495a57466b5a5849695853776959334a6c5a47567564476c6862464e31596d706c593351694f6e736962476c7a64456c6b496a6f784d6a4d73496d466a59323931626e524a5a434936496a42344d54566a515455784e6a4931513055354e6a51315a4463774d54557a4e5449774e6d45325254597a596a42454d5464684d5441354f534a396653776961584e7a496a6f695a476c6b4f6e5a6c6247396a615852354f6a42345a44526b5a6a49354e7a49325a4455774d475935596a6731596d4d32597a646d4d57497a597a41794d5759784e6a4d774e5459354d694973496d703061534936496d5630614756795a5856744f6a42344d4449794e444d304d6a49774e6d4d77597a51354f54466c4f44646959554a6b516a6c47596a5a6c513255304d44526a4e3252465153396e5a5854516f584a6c5a47567564476c686245316c6447466b5958526854476c7a64456c7a6333566c636c5a445032466b5a484a6c63334d394d4867784e574e424e5445324d6a564452546b324e44566b4e7a41784e544d314d6a413259545a464e6a4e694d4551784e3245784d446b354a6d78706333524a5a4430784d6a4d694c434a70595851694f6a45324e4441794e6a6b344e545173496d35695a6949364d5459304d4449324f5467314e48302e4179555a753977626942756a4f506853756b5278495843504c65334b36475a68734b2d6431337036704d667855685048366b5a41475a6d534562635166484d33456845726237507378664971475f75546572366f2d6700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a747261636b696e67496400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f6469643a76656c6f636974793a34320000000000000000000000000000000000',
        topics: [
          '0x5b3dbf2c1245cb7fe5833a37872aae67caba79bd65f30522e778fc48297376a5',
        ],
        transactionHash:
          '0xff7494996821a28cffc9e5d95b4851961322e5f32269e87c4d6fad7f5626e699',
        logIndex: 0,
        event: 'AddedCredentialMetadata',
        eventSignature:
          'AddedCredentialMetadata(address,bytes,uint256,bytes2,uint32,string,string)',
        args: [
          '0x6F80d1630992e6634e4f7Cd5af1BeB9830e47EdD',
          // eslint-disable-next-line max-len
          '0x65794a30655841694f694a4b563151694c434a72615751694f694a6b61575136646d567362324e7064486b364d48686b4e47526d4d6a6b334d6a5a6b4e5441775a6a6c694f445669597a5a6a4e325978596a4e6a4d4449785a6a45324d7a41314e6a6b794932746c65533078496977695957786e496a6f6952564d794e545a4c496e302e65794a325979493665794a306558426c496a7062496b4e795a57526c626e52705957784e5a5852685a47463059557870633352495a57466b5a5849695853776959334a6c5a47567564476c6862464e31596d706c593351694f6e736962476c7a64456c6b496a6f784d6a4d73496d466a59323931626e524a5a434936496a42344d54566a515455784e6a4931513055354e6a51315a4463774d54557a4e5449774e6d45325254597a596a42454d5464684d5441354f534a396653776961584e7a496a6f695a476c6b4f6e5a6c6247396a615852354f6a42345a44526b5a6a49354e7a49325a4455774d475935596a6731596d4d32597a646d4d57497a597a41794d5759784e6a4d774e5459354d694973496d703061534936496d5630614756795a5856744f6a42344d4449794e444d304d6a49774e6d4d77597a51354f54466c4f44646959554a6b516a6c47596a5a6c513255304d44526a4e3252465153396e5a5854516f584a6c5a47567564476c686245316c6447466b5958526854476c7a64456c7a6333566c636c5a445032466b5a484a6c63334d394d4867784e574e424e5445324d6a564452546b324e44566b4e7a41784e544d314d6a413259545a464e6a4e694d4551784e3245784d446b354a6d78706333524a5a4430784d6a4d694c434a70595851694f6a45324e4441794e6a6b344e545173496d35695a6949364d5459304d4449324f5467314e48302e4179555a753977626942756a4f506853756b5278495843504c65334b36475a68734b2d6431337036704d667855685048366b5a41475a6d534562635166484d33456845726237507378664971475f75546572366f2d67',
          {
            type: 'BigNumber',
            hex: '0x01',
          },
          credentialSchemaHashLayer2,
          2,
          'trackingId',
          'did:velocity:42',
        ],
      },
    ];
    mockEventCursorNext.mockReset();
    mockEventCursor.mockImplementation(() => {
      return {
        [Symbol.asyncIterator]: () => {
          return {
            next: mockEventCursorNext
              .mockImplementationOnce(async () => {
                return { value: [] };
              })
              .mockImplementationOnce(async () => {
                return { value: eventsForMock };
              })
              .mockImplementationOnce(async () => {
                return { done: true };
              }),
          };
        },
      };
    });
    const func = async () => handleCredentialIssuedRewardsEvent(testContext);
    await expect(func()).resolves.toEqual(undefined);
    expect(mockInitReadDocument).toHaveBeenCalledTimes(1);
    expect(mockInitWriteDocument).toHaveBeenCalledTimes(1);
    expect(mockInitMetadataRegistry).toHaveBeenCalledTimes(1);

    expect(mockReadDocument).toHaveBeenCalledTimes(1);
    expect(mockReadDocument).toHaveBeenCalledWith(
      testContext.config.dynamoDbTableEventBlock,
      { EventName: task }
    );

    expect(mockPullAddedCredentialMetadataEvents).toHaveBeenCalledTimes(1);
    expect(mockPullAddedCredentialMetadataEvents).toHaveBeenCalledWith(2);

    expect(mockBatchTransferCredits).toHaveBeenCalledTimes(1);
    expect(mockBatchTransferCredits).toHaveBeenCalledWith(
      {
        transfers: expect.arrayContaining([
          {
            amount: 7,
            description: 'CAO_ISSUING_REWARD',
            fromAccount: 'abc123',
            toAccount: '9',
          },
          {
            amount: 5,
            fromAccount: 'abc123',
            toAccount: '9',
            description: TransactionTypes.ISSUER_ISSUING_REWARD,
          },
        ]),
      },
      testContext
    );

    expect(mockWriteDocument).toHaveBeenCalledTimes(1);
    expect(mockWriteDocument).toHaveBeenCalledWith(
      testContext.config.dynamoDbTableEventBlock,
      {
        EventName: task,
        BlockNumber: 42,
      }
    );
    expect(mockEventCursor).toHaveBeenCalledTimes(1);
    expect(mockEventCursorNext).toHaveBeenCalledTimes(3);
  });

  it('Should not distribute rewards for layer 2 credentials', async () => {
    mockReadDocument.mockResolvedValue({
      Item: {
        EventName: task,
        BlockNumber: 1,
      },
    });
    const eventsForMock = [
      {
        blockNumber: 157143,
        blockHash:
          '0x6eeb22a01c33cecb0a117252fed4fee1948d9cd19a7d30fc7c8fc338ec82bd4e',
        transactionIndex: 0,
        removed: false,
        address: '0x9c7A0CD7829c31259b2D19B808a69687267c939b',
        // eslint-disable-next-line max-len
        data: '0x0000000000000000000000006f80d1630992e6634e4f7cd5af1beb9830e47edd00000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000000000000000000000000000000000000000001673200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000044000000000000000000000000000000000000000000000000000000000000002ea65794a30655841694f694a4b563151694c434a72615751694f694a6b61575136646d567362324e7064486b364d48686b4e47526d4d6a6b334d6a5a6b4e5441775a6a6c694f445669597a5a6a4e325978596a4e6a4d4449785a6a45324d7a41314e6a6b794932746c65533078496977695957786e496a6f6952564d794e545a4c496e302e65794a325979493665794a306558426c496a7062496b4e795a57526c626e52705957784e5a5852685a47463059557870633352495a57466b5a5849695853776959334a6c5a47567564476c6862464e31596d706c593351694f6e736962476c7a64456c6b496a6f784d6a4d73496d466a59323931626e524a5a434936496a42344d54566a515455784e6a4931513055354e6a51315a4463774d54557a4e5449774e6d45325254597a596a42454d5464684d5441354f534a396653776961584e7a496a6f695a476c6b4f6e5a6c6247396a615852354f6a42345a44526b5a6a49354e7a49325a4455774d475935596a6731596d4d32597a646d4d57497a597a41794d5759784e6a4d774e5459354d694973496d703061534936496d5630614756795a5856744f6a42344d4449794e444d304d6a49774e6d4d77597a51354f54466c4f44646959554a6b516a6c47596a5a6c513255304d44526a4e3252465153396e5a5854516f584a6c5a47567564476c686245316c6447466b5958526854476c7a64456c7a6333566c636c5a445032466b5a484a6c63334d394d4867784e574e424e5445324d6a564452546b324e44566b4e7a41784e544d314d6a413259545a464e6a4e694d4551784e3245784d446b354a6d78706333524a5a4430784d6a4d694c434a70595851694f6a45324e4441794e6a6b344e545173496d35695a6949364d5459304d4449324f5467314e48302e4179555a753977626942756a4f506853756b5278495843504c65334b36475a68734b2d6431337036704d667855685048366b5a41475a6d534562635166484d33456845726237507378664971475f75546572366f2d6700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a747261636b696e67496400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f6469643a76656c6f636974793a34320000000000000000000000000000000000',
        topics: [
          '0x5b3dbf2c1245cb7fe5833a37872aae67caba79bd65f30522e778fc48297376a5',
        ],
        transactionHash:
          '0x2b50833123fe62a229aaa7143d4f62f12d6d6f2c10ef34ef9c246212f24d0ce5',
        logIndex: 0,
        event: 'AddedCredentialMetadata',
        eventSignature:
          'AddedCredentialMetadata(address,bytes,uint256,bytes2,uint32,string,string)',
        args: [
          '0x6F80d1630992e6634e4f7Cd5af1BeB9830e47EdD',
          // eslint-disable-next-line max-len
          '0x65794a30655841694f694a4b563151694c434a72615751694f694a6b61575136646d567362324e7064486b364d48686b4e47526d4d6a6b334d6a5a6b4e5441775a6a6c694f445669597a5a6a4e325978596a4e6a4d4449785a6a45324d7a41314e6a6b794932746c65533078496977695957786e496a6f6952564d794e545a4c496e302e65794a325979493665794a306558426c496a7062496b4e795a57526c626e52705957784e5a5852685a47463059557870633352495a57466b5a5849695853776959334a6c5a47567564476c6862464e31596d706c593351694f6e736962476c7a64456c6b496a6f784d6a4d73496d466a59323931626e524a5a434936496a42344d54566a515455784e6a4931513055354e6a51315a4463774d54557a4e5449774e6d45325254597a596a42454d5464684d5441354f534a396653776961584e7a496a6f695a476c6b4f6e5a6c6247396a615852354f6a42345a44526b5a6a49354e7a49325a4455774d475935596a6731596d4d32597a646d4d57497a597a41794d5759784e6a4d774e5459354d694973496d703061534936496d5630614756795a5856744f6a42344d4449794e444d304d6a49774e6d4d77597a51354f54466c4f44646959554a6b516a6c47596a5a6c513255304d44526a4e3252465153396e5a5854516f584a6c5a47567564476c686245316c6447466b5958526854476c7a64456c7a6333566c636c5a445032466b5a484a6c63334d394d4867784e574e424e5445324d6a564452546b324e44566b4e7a41784e544d314d6a413259545a464e6a4e694d4551784e3245784d446b354a6d78706333524a5a4430784d6a4d694c434a70595851694f6a45324e4441794e6a6b344e545173496d35695a6949364d5459304d4449324f5467314e48302e4179555a753977626942756a4f506853756b5278495843504c65334b36475a68734b2d6431337036704d667855685048366b5a41475a6d534562635166484d33456845726237507378664971475f75546572366f2d67',
          {
            type: 'BigNumber',
            hex: '0x01',
          },
          credentialSchemaHashLayer2,
          1,
          'trackingId',
          'did:velocity:0xd4df29726d500f9b85bc6c7f1b3c021f16305692',
        ],
      },
      {
        blockNumber: 157144,
        blockHash:
          '0x635702479e12c015e5d99b006cbcd8e3b83bb54bd7d390b2e3804a8fd7e48280',
        transactionIndex: 0,
        removed: false,
        address: '0x9c7A0CD7829c31259b2D19B808a69687267c939b',
        // eslint-disable-next-line max-len
        data: '0x0000000000000000000000006f80d1630992e6634e4f7cd5af1beb9830e47edd00000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000000000000000000000000000000000000000001673200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000044000000000000000000000000000000000000000000000000000000000000002ea65794a30655841694f694a4b563151694c434a72615751694f694a6b61575136646d567362324e7064486b364d48686b4e47526d4d6a6b334d6a5a6b4e5441775a6a6c694f445669597a5a6a4e325978596a4e6a4d4449785a6a45324d7a41314e6a6b794932746c65533078496977695957786e496a6f6952564d794e545a4c496e302e65794a325979493665794a306558426c496a7062496b4e795a57526c626e52705957784e5a5852685a47463059557870633352495a57466b5a5849695853776959334a6c5a47567564476c6862464e31596d706c593351694f6e736962476c7a64456c6b496a6f784d6a4d73496d466a59323931626e524a5a434936496a42344d54566a515455784e6a4931513055354e6a51315a4463774d54557a4e5449774e6d45325254597a596a42454d5464684d5441354f534a396653776961584e7a496a6f695a476c6b4f6e5a6c6247396a615852354f6a42345a44526b5a6a49354e7a49325a4455774d475935596a6731596d4d32597a646d4d57497a597a41794d5759784e6a4d774e5459354d694973496d703061534936496d5630614756795a5856744f6a42344d4449794e444d304d6a49774e6d4d77597a51354f54466c4f44646959554a6b516a6c47596a5a6c513255304d44526a4e3252465153396e5a5854516f584a6c5a47567564476c686245316c6447466b5958526854476c7a64456c7a6333566c636c5a445032466b5a484a6c63334d394d4867784e574e424e5445324d6a564452546b324e44566b4e7a41784e544d314d6a413259545a464e6a4e694d4551784e3245784d446b354a6d78706333524a5a4430784d6a4d694c434a70595851694f6a45324e4441794e6a6b344e545173496d35695a6949364d5459304d4449324f5467314e48302e4179555a753977626942756a4f506853756b5278495843504c65334b36475a68734b2d6431337036704d667855685048366b5a41475a6d534562635166484d33456845726237507378664971475f75546572366f2d6700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a747261636b696e67496400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f6469643a76656c6f636974793a34320000000000000000000000000000000000',
        topics: [
          '0x5b3dbf2c1245cb7fe5833a37872aae67caba79bd65f30522e778fc48297376a5',
        ],
        transactionHash:
          '0xff7494996821a28cffc9e5d95b4851961322e5f32269e87c4d6fad7f5626e699',
        logIndex: 0,
        event: 'AddedCredentialMetadata',
        eventSignature:
          'AddedCredentialMetadata(address,bytes,uint256,bytes2,uint32,string,string)',
        args: [
          '0x6F80d1630992e6634e4f7Cd5af1BeB9830e47EdD',
          // eslint-disable-next-line max-len
          '0x65794a30655841694f694a4b563151694c434a72615751694f694a6b61575136646d567362324e7064486b364d48686b4e47526d4d6a6b334d6a5a6b4e5441775a6a6c694f445669597a5a6a4e325978596a4e6a4d4449785a6a45324d7a41314e6a6b794932746c65533078496977695957786e496a6f6952564d794e545a4c496e302e65794a325979493665794a306558426c496a7062496b4e795a57526c626e52705957784e5a5852685a47463059557870633352495a57466b5a5849695853776959334a6c5a47567564476c6862464e31596d706c593351694f6e736962476c7a64456c6b496a6f784d6a4d73496d466a59323931626e524a5a434936496a42344d54566a515455784e6a4931513055354e6a51315a4463774d54557a4e5449774e6d45325254597a596a42454d5464684d5441354f534a396653776961584e7a496a6f695a476c6b4f6e5a6c6247396a615852354f6a42345a44526b5a6a49354e7a49325a4455774d475935596a6731596d4d32597a646d4d57497a597a41794d5759784e6a4d774e5459354d694973496d703061534936496d5630614756795a5856744f6a42344d4449794e444d304d6a49774e6d4d77597a51354f54466c4f44646959554a6b516a6c47596a5a6c513255304d44526a4e3252465153396e5a5854516f584a6c5a47567564476c686245316c6447466b5958526854476c7a64456c7a6333566c636c5a445032466b5a484a6c63334d394d4867784e574e424e5445324d6a564452546b324e44566b4e7a41784e544d314d6a413259545a464e6a4e694d4551784e3245784d446b354a6d78706333524a5a4430784d6a4d694c434a70595851694f6a45324e4441794e6a6b344e545173496d35695a6949364d5459304d4449324f5467314e48302e4179555a753977626942756a4f506853756b5278495843504c65334b36475a68734b2d6431337036704d667855685048366b5a41475a6d534562635166484d33456845726237507378664971475f75546572366f2d67',
          {
            type: 'BigNumber',
            hex: '0x01',
          },
          credentialSchemaHashLayer2,
          2,
          'trackingId',
          'did:velocity:0xd4df29726d500f9b85bc6c7f1b3c021f16305692',
        ],
      },
      {
        blockNumber: 157145,
        blockHash:
          '0x635702479e12c015e5d99b006cbcd8e3b83bb54bd7d390b2e3804a8fd7e48280',
        transactionIndex: 0,
        removed: false,
        address: '0x9c7A0CD7829c31259b2D19B808a69687267c939b',
        // eslint-disable-next-line max-len
        data: '0x0000000000000000000000006f80d1630992e6634e4f7cd5af1beb9830e47edd00000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000000000000000000000000000000000000000001673200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000044000000000000000000000000000000000000000000000000000000000000002ea65794a30655841694f694a4b563151694c434a72615751694f694a6b61575136646d567362324e7064486b364d48686b4e47526d4d6a6b334d6a5a6b4e5441775a6a6c694f445669597a5a6a4e325978596a4e6a4d4449785a6a45324d7a41314e6a6b794932746c65533078496977695957786e496a6f6952564d794e545a4c496e302e65794a325979493665794a306558426c496a7062496b4e795a57526c626e52705957784e5a5852685a47463059557870633352495a57466b5a5849695853776959334a6c5a47567564476c6862464e31596d706c593351694f6e736962476c7a64456c6b496a6f784d6a4d73496d466a59323931626e524a5a434936496a42344d54566a515455784e6a4931513055354e6a51315a4463774d54557a4e5449774e6d45325254597a596a42454d5464684d5441354f534a396653776961584e7a496a6f695a476c6b4f6e5a6c6247396a615852354f6a42345a44526b5a6a49354e7a49325a4455774d475935596a6731596d4d32597a646d4d57497a597a41794d5759784e6a4d774e5459354d694973496d703061534936496d5630614756795a5856744f6a42344d4449794e444d304d6a49774e6d4d77597a51354f54466c4f44646959554a6b516a6c47596a5a6c513255304d44526a4e3252465153396e5a5854516f584a6c5a47567564476c686245316c6447466b5958526854476c7a64456c7a6333566c636c5a445032466b5a484a6c63334d394d4867784e574e424e5445324d6a564452546b324e44566b4e7a41784e544d314d6a413259545a464e6a4e694d4551784e3245784d446b354a6d78706333524a5a4430784d6a4d694c434a70595851694f6a45324e4441794e6a6b344e545173496d35695a6949364d5459304d4449324f5467314e48302e4179555a753977626942756a4f506853756b5278495843504c65334b36475a68734b2d6431337036704d667855685048366b5a41475a6d534562635166484d33456845726237507378664971475f75546572366f2d6700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a747261636b696e67496400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f6469643a76656c6f636974793a34320000000000000000000000000000000000',
        topics: [
          '0x5b3dbf2c1245cb7fe5833a37872aae67caba79bd65f30522e778fc48297376a5',
        ],
        transactionHash:
          '0xff7494996821a28cffc9e5d95b4851961322e5f32269e87c4d6fad7f5626e699',
        logIndex: 0,
        event: 'AddedCredentialMetadata',
        eventSignature:
          'AddedCredentialMetadata(address,bytes,uint256,bytes2,uint32,string,string)',
        args: [
          '0x6F80d1630992e6634e4f7Cd5af1BeB9830e47EdD',
          // eslint-disable-next-line max-len
          '0x65794a30655841694f694a4b563151694c434a72615751694f694a6b61575136646d567362324e7064486b364d48686b4e47526d4d6a6b334d6a5a6b4e5441775a6a6c694f445669597a5a6a4e325978596a4e6a4d4449785a6a45324d7a41314e6a6b794932746c65533078496977695957786e496a6f6952564d794e545a4c496e302e65794a325979493665794a306558426c496a7062496b4e795a57526c626e52705957784e5a5852685a47463059557870633352495a57466b5a5849695853776959334a6c5a47567564476c6862464e31596d706c593351694f6e736962476c7a64456c6b496a6f784d6a4d73496d466a59323931626e524a5a434936496a42344d54566a515455784e6a4931513055354e6a51315a4463774d54557a4e5449774e6d45325254597a596a42454d5464684d5441354f534a396653776961584e7a496a6f695a476c6b4f6e5a6c6247396a615852354f6a42345a44526b5a6a49354e7a49325a4455774d475935596a6731596d4d32597a646d4d57497a597a41794d5759784e6a4d774e5459354d694973496d703061534936496d5630614756795a5856744f6a42344d4449794e444d304d6a49774e6d4d77597a51354f54466c4f44646959554a6b516a6c47596a5a6c513255304d44526a4e3252465153396e5a5854516f584a6c5a47567564476c686245316c6447466b5958526854476c7a64456c7a6333566c636c5a445032466b5a484a6c63334d394d4867784e574e424e5445324d6a564452546b324e44566b4e7a41784e544d314d6a413259545a464e6a4e694d4551784e3245784d446b354a6d78706333524a5a4430784d6a4d694c434a70595851694f6a45324e4441794e6a6b344e545173496d35695a6949364d5459304d4449324f5467314e48302e4179555a753977626942756a4f506853756b5278495843504c65334b36475a68734b2d6431337036704d667855685048366b5a41475a6d534562635166484d33456845726237507378664971475f75546572366f2d67',
          {
            type: 'BigNumber',
            hex: '0x01',
          },
          credentialSchemaHashLayer2,
          2,
          'trackingId',
          'did:velocity:42',
        ],
      },
    ];
    mockEventCursorNext.mockReset();
    mockEventCursor.mockImplementation(() => {
      return {
        [Symbol.asyncIterator]: () => {
          return {
            next: mockEventCursorNext
              .mockImplementationOnce(async () => {
                return { value: [] };
              })
              .mockImplementationOnce(async () => {
                return { value: eventsForMock };
              })
              .mockImplementationOnce(async () => {
                return { done: true };
              }),
          };
        },
      };
    });
    const func = async () => handleCredentialIssuedRewardsEvent(testContext);
    await expect(func()).resolves.toEqual(undefined);
    expect(mockInitReadDocument).toHaveBeenCalledTimes(1);
    expect(mockInitWriteDocument).toHaveBeenCalledTimes(1);
    expect(mockInitMetadataRegistry).toHaveBeenCalledTimes(1);

    expect(mockReadDocument).toHaveBeenCalledTimes(1);
    expect(mockReadDocument).toHaveBeenCalledWith(
      testContext.config.dynamoDbTableEventBlock,
      { EventName: task }
    );

    expect(mockPullAddedCredentialMetadataEvents).toHaveBeenCalledTimes(1);
    expect(mockPullAddedCredentialMetadataEvents).toHaveBeenCalledWith(2);

    expect(mockBatchTransferCredits).toHaveBeenCalledTimes(0);
    expect(mockWriteDocument).toHaveBeenCalledTimes(1);
    expect(mockWriteDocument).toHaveBeenCalledWith(
      testContext.config.dynamoDbTableEventBlock,
      {
        EventName: task,
        BlockNumber: 42,
      }
    );
    expect(mockEventCursor).toHaveBeenCalledTimes(1);
    expect(mockEventCursorNext).toHaveBeenCalledTimes(3);
  });

  it('Should successfully handle initial case of no existing blocks', async () => {
    mockReadDocument.mockResolvedValue(undefined);

    const func = async () => handleCredentialIssuedRewardsEvent(testContext);

    await expect(func()).resolves.toEqual(undefined);

    expect(mockPullAddedCredentialMetadataEvents).toHaveBeenCalledWith(0);
  });

  it('Should reject organizations with missing tokenAccountId', async () => {
    mockReadDocument.mockResolvedValue(undefined);

    await mongoDb()
      .collection('organizations')
      .updateOne(
        { _id: new ObjectId(organizations[1]._id) },
        {
          $unset: {
            ids: '',
          },
        }
      );
    const func = async () => handleCredentialIssuedRewardsEvent(testContext);

    await expect(func()).resolves.toEqual(undefined);

    expect(mockPullAddedCredentialMetadataEvents).toHaveBeenCalledWith(0);
  });

  it('Should still update block when there are no events to process', async () => {
    mockEventCursorNext.mockReset();
    mockEventCursor.mockImplementation(() => {
      return {
        [Symbol.asyncIterator]: () => {
          return {
            next: mockEventCursorNext
              .mockImplementationOnce(async () => {
                return { value: [] };
              })
              .mockImplementationOnce(async () => {
                return { value: [] };
              })
              .mockImplementationOnce(async () => {
                return { done: true };
              }),
          };
        },
      };
    });
    const func = async () => handleCredentialIssuedRewardsEvent(testContext);

    await expect(func()).resolves.toEqual(undefined);

    expect(mockBatchTransferCredits).toHaveBeenCalledTimes(0);
    expect(mockWriteDocument).toHaveBeenCalledTimes(1);
    expect(mockWriteDocument).toHaveBeenCalledWith(
      testContext.config.dynamoDbTableEventBlock,
      {
        EventName: task,
        BlockNumber: 42,
      }
    );
  });
});
