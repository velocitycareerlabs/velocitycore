FROM hyperledger/besu:24.8.0@sha256:ff205723041323251f78db8a18580117a5e728b994860b03a40e4e8d16c0e0b5

COPY entrypoint.sh /opt/besu/entrypoint.sh
COPY genesis.tpl /opt/besu/genesis.tpl
COPY log-config.xml /opt/besu/log-config.xml
COPY auth.pem /opt/besu/auth.pem

USER root

RUN chown -R besu:besu .
RUN chown -R besu:besu /var/log/
RUN chmod 755 entrypoint.sh

USER besu

ARG BESU_CHAIN_ID
ARG BESU_BOOTNODES
ARG BESU_INITIAL_VALIDATORS

ENV LOG4J_CONFIGURATION_FILE=/opt/besu/log-config.xml \
    BESU_PROFILE=ENTERPRISE \
    BESU_XDNS_ENABLED=true \
    BESU_XDNS_UPDATE_ENABLED=true \
    BESU_DATA_PATH=data \
    BESU_GENESIS_FILE=genesis.json \
    BESU_HOST_ALLOWLIST=* \
    BESU_MIN_GAS_PRICE=0 \
    BESU_NODE_PRIVATE_KEY_FILE=key \
    BESU_P2P_HOST=0.0.0.0 \
    BESU_MAX_PEERS=30 \
    BESU_TX_POOL_RETENTION_HOURS=1 \
    BESU_TX_POOL_LIMIT_BY_ACCOUNT_PERCENTAGE=0.01 \
    BESU_REMOTE_CONNECTIONS_LIMIT_ENABLED=false \
    BESU_PERMISSIONS_ACCOUNTS_CONTRACT_ADDRESS=0x0000000000000000000000000000000000008888 \
    BESU_PERMISSIONS_ACCOUNTS_CONTRACT_ENABLED=false \
    BESU_PERMISSIONS_NODES_CONTRACT_ADDRESS=0x0000000000000000000000000000000000009999 \
    BESU_PERMISSIONS_NODES_CONTRACT_ENABLED=true \
    BESU_PERMISSIONS_NODES_CONTRACT_VERSION=2 \
    BESU_RPC_HTTP_API=ETH,NET,WEB3,IBFT \
    BESU_RPC_HTTP_CORS_ORIGINS="all" \
    BESU_RPC_HTTP_ENABLED=true \
    BESU_RPC_HTTP_AUTHENTICATION_ENABLED=true \
    BESU_RPC_HTTP_AUTHENTICATION_JWT_PUBLIC_KEY_FILE=/opt/besu/auth.pem \
    BESU_RPC_HTTP_TLS_ENABLED=true \
    BESU_RPC_HTTP_TLS_KEYSTORE_FILE=/opt/besu/keystore.pfx \
    BESU_RPC_HTTP_TLS_KEYSTORE_PASSWORD_FILE=/opt/besu/password \
    BESU_TLS_BASE64_KEYSTORE= \
    BESU_TLS_KEYSTORE_PASSWORD= \
    BESU_PRIVATE_KEY= \
    BESU_CHAIN_ID=${BESU_CHAIN_ID} \
    BESU_BOOTNODES=${BESU_BOOTNODES} \
    BESU_INITIAL_VALIDATORS=${BESU_INITIAL_VALIDATORS} 

ENTRYPOINT [ "/opt/besu/entrypoint.sh" ]
